MPASM  5.51                        KEYPAD.ASM   6-12-2022  19:11:07         PAGE  1


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00001 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      00002 ; 
                      00003 ;       KEYPAD.ASM      MPB     Ver 1.0         28-8-05 
                      00004 ; 
                      00005 ;       Reads keypad and shows digit on display
                      00006 ;       Design file KEYPAD.DSN
                      00007 ; 
                      00008 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      00009  
                      00010         PROCESSOR 16F877
                      00011 
  00000002            00012 PCL             EQU     002             ; Program Counter
  00000006            00013 PORTB   EQU 06  ; Port B Data Register        
  00000007            00014 PORTC   EQU     007             ; 7-Segment display
  00000008            00015 PORTD   EQU     008             ; 3x4 keypad
  00000003            00016 STATUS  EQU 003
                      00017 
  00000086            00018 TRISB   EQU     086             ; Data direction
  00000087            00019 TRISC   EQU     087             ; Data direction
  00000088            00020 TRISD   EQU     088             ; registers
                      00021 
  0000000B            00022 INTCON  EQU     0B      ; Interrupt Control Register
                      00023 
  00000020            00024 Key     EQU     020             ; Count of keys
                      00025 
0000                  00026         ORG     000             ; Start of program memory
0000   0000           00027         NOP                     ; For ICD mode
0001   2819           00028         GOTO start      ; Jump to main program
                      00029 
                      00030 ; Interrupt Service Routine ................................
                      00031 
0004                  00032         ORG     004
0004   1C0B           00033         BTFSS INTCON, 0
0005   2818           00034         goto other_int
                      00035 
0006   1A06           00036         BTFSC PORTB, 4  ; Check if PortB.4 (column 4)
0007   280C           00037         goto check_col_2
0008   202F           00038         call scan
0009   2048           00039         call show               ; and display it
000A   100B           00040         BCF INTCON, 0   ; Reset the interrupt flag
000B   2818           00041         goto other_int
                      00042 
000C                  00043 check_col_2
000C   1A86           00044         BTFSC PORTB, 5  ; Check if PortB.5 (column 5)
000D   2812           00045         goto check_col_3
000E   202F           00046         call scan
000F   2048           00047         call show               ; and display it
0010   100B           00048         BCF INTCON, 0   ; Reset the interrupt flag
0011   2818           00049         goto other_int
                      00050 
0012                  00051 check_col_3
0012   1B06           00052         BTFSC PORTB, 6  ; Check if PortB.6 (column 6)
0013   2818           00053         goto other_int
MPASM  5.51                        KEYPAD.ASM   6-12-2022  19:11:07         PAGE  2


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0014   202F           00054         call scan
0015   2048           00055         call show               ; and display it
0016   100B           00056         BCF INTCON, 0   ; Reset the interrupt flag
0017   2818           00057         goto other_int
                      00058 
0018                  00059 other_int
                      00060         
0018   0009           00061         RETFIE                  ; Return from interrupt
                      00062 
                      00063 
                      00064 ; Initialise ports.........................................
                      00065 
0019                  00066 start
0019   1683 1303      00067         BANKSEL TRISC           ; Display. 7-segment display
001B   0103           00068         CLRW                            ; all outputs
Message[302]: Register in operand not in bank 0.  Ensure that bank bits are correct.
001C   0087           00069         MOVWF   TRISC           ; 
001D   3070           00070         MOVLW   B'01110000'     ; Keypad
Message[302]: Register in operand not in bank 0.  Ensure that bank bits are correct.
001E   0086           00071         MOVWF   TRISB           ; PortB pins 6, 5, 4 is input (columns)
                      00072 
001F   3088           00073         MOVLW   B'10001000'     ; enable GIE (bit 7), RBIE (bit 3)
Message[302]: Register in operand not in bank 0.  Ensure that bank bits are correct.
0020   0086           00074         MOVWF   TRISB           ; PortB pins
                      00075 
0021   1283 1303      00076         BANKSEL PORTC           ; Display off
0023   0187           00077         CLRF    PORTC           ; initially
0024   284B           00078         GOTO    main            ; jump to main
                      00079 
                      00080 ; Check a row of keys .....................................
                      00081 
Message[305]: Using default destination of 1 (file).
0025   0AA0           00082 row     INCF    Key                     ; Count first key
0026   1C08           00083         BTFSS   PORTD,0         ; Check key
0027   2838           00084         GOTO    found           ; and quit if on
                      00085 
Message[305]: Using default destination of 1 (file).
0028   0AA0           00086         INCF    Key             ; and repeat
0029   1C88           00087         BTFSS   PORTD,1         ; for second 
002A   2838           00088         GOTO    found           ; key
                      00089 
Message[305]: Using default destination of 1 (file).
002B   0AA0           00090         INCF    Key             ; and repeat
002C   1D08           00091         BTFSS   PORTD,2         ; for third
002D   2838           00092         GOTO    found           ; key
002E   2833           00093         GOTO    next            ; go for next row
                      00094 
                      00095 ; Scan the keypad..........................................
                      00096 
002F   01A0           00097 scan    CLRF Key                ; Zero key count 
0030   1403           00098                 BSF     STATUS,0        ; Set Carry Flag 
0031   1208           00099                 BCF     PORTD,4         ; Select first row
0032   2825           00100 newrow  GOTO    row             ; check row
MPASM  5.51                        KEYPAD.ASM   6-12-2022  19:11:07         PAGE  3


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00101 
0033   1588           00102 next    BSF     PORTD,3         ; Set fill bit
Message[305]: Using default destination of 1 (file).
0034   0D88           00103                 RLF     PORTD           ; Select next row
0035   1803           00104                 BTFSC   STATUS,0                ; 0 into carry flag?
0036   2832           00105                 GOTO    newrow          ; if not, next row
0037   282F           00106                 GOTO    scan            ; if so, start again
                      00107 
0038   0008           00108 found   RETURN                  ; quit with key count
                      00109 
                      00110 ; Display code table.......................................
                      00111 
0039   0820           00112 table   MOVF    Key,W           ; Get key count
Message[305]: Using default destination of 1 (file).
003A   0782           00113         ADDWF   PCL             ; and calculate jump
003B   0000           00114         NOP                     ; into table 
003C   340C           00115         RETLW   B'00001100'     ; Code for '1'
003D   34B6           00116         RETLW   B'10110110'     ; Code for '2'
003E   349E           00117         RETLW   B'10011110'     ; Code for '3'
003F   34CC           00118         RETLW   B'11001100'     ; Code for '4'
0040   34DA           00119         RETLW   B'11011010'     ; Code for '5'
0041   34F8           00120         RETLW   B'11111000'     ; Code for '6'
0042   340E           00121         RETLW   B'00001110'     ; Code for '7'  
0043   34FE           00122         RETLW   B'11111110'     ; Code for '8'
0044   34CE           00123         RETLW   B'11001110'     ; Code for '9'
0045   3492           00124         RETLW   B'10010010'     ; Code for '*'
0046   347E           00125         RETLW   B'01111110'     ; Code for '0'
0047   34EC           00126         RETLW   B'11101100'     ; Code for '#'
                      00127 
                      00128 ; Output display code......................................
                      00129 
0048   2039           00130 show    CALL    table           ; Get display code
0049   0087           00131                 MOVWF   PORTC           ; and show it
004A   0008           00132                 RETURN
                      00133 
                      00134 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      00135 
                      00136 ; Read keypad & display....
                      00137 
004B   30FF           00138 main    MOVLW   0FF             ; Set all outputs 
004C   0088           00139                 MOVWF   PORTD   ; to keypad high
004D   0063           00140                 sleep                   ; Put the chip in low power mode
004E   284B           00141                 GOTO    main            ; and repeat
                      00142                 END
MPASM  5.51                        KEYPAD.ASM   6-12-2022  19:11:07         PAGE  4


SYMBOL TABLE
  LABEL                             VALUE 

INTCON                            0000000B
Key                               00000020
PCL                               00000002
PORTB                             00000006
PORTC                             00000007
PORTD                             00000008
STATUS                            00000003
TRISB                             00000086
TRISC                             00000087
TRISD                             00000088
__16F877A                         00000001
__DEBUG                           1
check_col_2                       0000000C
check_col_3                       00000012
found                             00000038
main                              0000004B
newrow                            00000032
next                              00000033
other_int                         00000018
row                               00000025
scan                              0000002F
show                              00000048
start                             00000019
table                             00000039


MEMORY USAGE MAP ('X' = Used,  '-' = Unused)

0000 : XX--XXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0040 : XXXXXXXXXXXXXXX- ---------------- ---------------- ----------------

All other memory blocks unused.

Program Memory Words Used:    77
Program Memory Words Free:  8115


Errors   :     0
Warnings :     0 reported,     0 suppressed
Messages :     8 reported,     0 suppressed

